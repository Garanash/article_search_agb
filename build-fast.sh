#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Å–±–æ—Ä–∫–∏ —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º

echo "üöÄ –ë—ã—Å—Ç—Ä–∞—è —Å–±–æ—Ä–∫–∞ —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º..."

# –í–∫–ª—é—á–∞–µ–º BuildKit –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1

# –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–µ—à–∏ (–Ω–µ –≤—Å–µ!)
echo "üßπ –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∫–µ—à–µ–π..."
docker builder prune -f --filter until=24h

# –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã
echo "‚¨áÔ∏è –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑–æ–≤—ã—Ö –æ–±—Ä–∞–∑–æ–≤..."
docker pull node:20-alpine &
docker pull nginx:alpine &
wait

# –°–±–æ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
if [ "$1" = "frontend" ]; then
    echo "üî® –°–±–æ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ frontend..."
    docker-compose build --parallel frontend
elif [ "$1" = "backend" ]; then
    echo "üî® –°–±–æ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ backend..."
    docker-compose build --parallel backend
else
    echo "üî® –°–±–æ—Ä–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤..."
    # –°–±–æ—Ä–∫–∞ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–æ–º
    docker-compose build --parallel
fi

echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –æ–±—Ä–∞–∑–æ–≤
echo "üìä –†–∞–∑–º–µ—Ä—ã –æ–±—Ä–∞–∑–æ–≤:"
docker images | grep article_search_agb
